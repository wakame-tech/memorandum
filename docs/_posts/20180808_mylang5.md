---
title: 自作言語インタプリタを作りたい5
date: 2018-08-08
tags: [言語処理系]
---
# 連勤6日目
連勤ももう慣れてきて長時間バイトもそこまで苦じゃなくなった、慣れって怖い。今日は4時間シフトなので帰ったら `Arcturus` の実装を進めます。最近コミット出来てなかったから。  


そういえば、言語の作り方に興味を持ったのに伴ってAmazonでこちらの本を購入しました。  
[まつもとゆきひろ 言語のしくみ Kindle版](https://www.amazon.co.jp/gp/product/B01N7JZXMD/ref=oh_aui_d_detailpage_o02_?ie=UTF8&psc=1)  
この本はプログラミング言語 `Ruby` の作者であるまつもとゆきひろ氏が１つの新しい言語を作る過程をRubyの裏話やソースコードを交えながら丁寧に解説されています。淡々と実装していくわけでなく試行錯誤しながら使用者を考える、つまり言語のデザインの仕方を学べるのでとてもいい本でした。それでは続きを。

# 7/26(8日目)
```
commit 612fa14d2a8edccb52c09960303098059bb6d799 '右辺値に変数を使うことが可能に'
commit 66f6ae54ab20bb684b2a23504464c80b369fdfab 'インクリメント、デクリメントに対応'
```

変数への代入の実装に手を加えて変数の代入とインクリメント、デクリメントが可能になりました。

### inc.ac
```
a: Int = 3
b: = a++
```

このコードを実行すると `a = 4, b = 4` と評価されます。注意したいのが `Arcturus` には `C` と違って `前置インクリメント`、`後置インクリメント` の概念がなく、二項演算子より優先順位の高い単項演算子というだけなので `C` とは違う結果となっています。

### inc.c
```c
int a = 3;
int b = a++;
printf("%d %d\n", a, b); // a = 4, b = 3
```

さらに、

```
commit e68982bf3276daca2a5d0b6cd34101a654ac5d4b '関数定義と呼び出し動くように'
commit e8def05067cb594cdc5e90e1b560e00416cd1a9b '自動変数it, _nに対応'
```

関数定義と呼び出しの実装をしました。関数が定義されると `関数名` のシンボルがキーのハッシュが変数テーブルに作成されてそこに引数の情報が格納されます(値はまだない)。  

関数が呼び出されるとそのハッシュの変数に具体的な値がセットされて、関数本体が評価されます。そして最後に評価された値を関数の評価値としています。  

また自動変数 `it` と `_n` にも対応しています。宣言せずとも自動で割り当てられる変数なので自動変数です。 `it` は引数が１つの関数のみで使用できる引数を示す自動変数です。 `_n` はn番目の変数を示す自動変数です。またそれに伴って `it = 3` のような行為を防ぐため `Readonly` の概念も地味に加わっていたりします。

### autovar.ac
```
fn f1(i1: Int) -> Int {
     i1 + it + _1
 }

f1(1 + 1) // 6
```

のような結果となります。

```
commit 2e1768a04f7f7bf1482f1845bb6d9684b6bcbfa1 'ラムダ式の代入と呼び出しに対応'
commit 55e5a3e5f79301ffbe8e7733a2b059d2178aecba 'ラムダ式引数に対応'
```

なんとこの日はラムダ式も実装していました。とはいえ新しい実装は少ないです。なぜかというと、

### arcturus.rb
```
fn_name = SecureRandom.urlsafe_base64(8)
fn_type = _define_function(fn_name, node[1], node[2], [], true)
return ['lambda', fn_name, fn_type]
```

のように内部ではラムダ式は名前がランダムな文字列の関数です。なので引数がラムダ式であってもそれを評価すれば良いだけの話です。

### lambda_arg.ac
```
fn f(a: (Int) -> Int) -> Int {
    a(1)
}

f({ s: Int -> s + s }) // 2
```

上のようなコードが動くようになりました。いいね。それでは。